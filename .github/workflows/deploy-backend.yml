# name: Deploy Backend to EC2

# on:
#   push:
#     tags:
#       - "back-v*"

# jobs:
#   deploy:
#     name: Deploy to EC2
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout cÃ³digo
#         uses: actions/checkout@v4

#       - name: Limpa target local
#         run: rm -rf backend/target

#       - name: Limpa projeto antigo no EC2
#         uses: appleboy/ssh-action@master
#         with:
#           host: ${{ secrets.EC2_HOST }}
#           username: ec2-user
#           key: ${{ secrets.EC2_SSH_KEY }}
#           script: |
#             echo "ðŸ§¹ Limpando projeto antigo no EC2..."
#             rm -rf spring-angular-contatos/backend/*

#       - name: Copia arquivos para EC2
#         uses: appleboy/scp-action@master
#         with:
#           host: ${{ secrets.EC2_HOST }}
#           username: ec2-user
#           key: ${{ secrets.EC2_SSH_KEY }}
#           source: "backend"
#           target: "~/spring-angular-contatos"

#       - name: SSH e build
#         uses: appleboy/ssh-action@master
#         with:
#           host: ${{ secrets.EC2_HOST }}
#           username: ec2-user
#           key: ${{ secrets.EC2_SSH_KEY }}
#           script: |
#             cd spring-angular-contatos/backend

#             echo "ðŸ§¹ Limpando arquivos antigos..."
#             rm -rf target/

#             chmod +x mvnw

#             echo "ðŸ’¡ Exportando variÃ¡veis de ambiente..."
#             export DB_URL="${{ secrets.DB_URL }}"
#             export DB_USERNAME="${{ secrets.DB_USERNAME }}"
#             export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
#             export COGNITO_ISSUER_URI="${{ secrets.COGNITO_ISSUER_URI }}"
#             export COGNITO_REGION="${{ secrets.COGNITO_REGION }}"
#             export COGNITO_USER_POOL_ID="${{ secrets.COGNITO_USER_POOL_ID }}"
#             export COGNITO_CLIENT_ID="${{ secrets.COGNITO_CLIENT_ID }}"

#             echo "ðŸ› ï¸ Buildando projeto..."
#             ./mvnw clean install || { echo "âŒ Build falhou!"; exit 1; }

#             echo "ðŸ” Procurando JAR..."
#             JAR_NAME=$(ls target/*.jar | head -n 1)

#             echo "ðŸ›‘ Matando app antigo..."
#             pkill -f 'java' && echo "AplicaÃ§Ã£o antiga encerrada." || echo "Nenhuma aplicaÃ§Ã£o em execuÃ§Ã£o."

#             echo "ðŸš€ Subindo app com variÃ¡veis de ambiente..."
#             nohup env \
#               DB_URL="${{ secrets.DB_URL }}" \
#               DB_USERNAME="${{ secrets.DB_USERNAME }}" \
#               DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
#               COGNITO_ISSUER_URI="${{ secrets.COGNITO_ISSUER_URI }}" \
#               COGNITO_REGION="${{ secrets.COGNITO_REGION }}" \
#               COGNITO_USER_POOL_ID="${{ secrets.COGNITO_USER_POOL_ID }}" \
#               COGNITO_CLIENT_ID="${{ secrets.COGNITO_CLIENT_ID }}" \
#               java -jar $JAR_NAME > app.log 2>&1 &

#             echo "âœ… AplicaÃ§Ã£o iniciada com sucesso!"
#             exit 0
name: Deploy Backend to EC2

on:
  push:
    tags:
      - "back-v*"

jobs:
  deploy:
    name: Build and Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build do backend
        run: |
          cd backend
          chmod +x mvnw
          ./mvnw clean package -DskipTests

      - name: Copia o JAR para EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "backend/target/backend-0.0.1-SNAPSHOT.jar"
          target: "~/spring-angular-contatos"

      - name: Atualiza .env e sobe a aplicaÃ§Ã£o
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/spring-angular-contatos

            echo "ðŸ”’ Atualizando variÃ¡veis de ambiente..."
            cat <<EOF > .env
            DB_URL=${{ secrets.DB_URL }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            COGNITO_ISSUER_URI=${{ secrets.COGNITO_ISSUER_URI }}
            COGNITO_REGION=${{ secrets.COGNITO_REGION }}
            COGNITO_USER_POOL_ID=${{ secrets.COGNITO_USER_POOL_ID }}
            COGNITO_CLIENT_ID=${{ secrets.COGNITO_CLIENT_ID }}
            EOF

            echo "ðŸ›‘ Encerrando aplicaÃ§Ã£o antiga se existir..."
            pkill -f 'backend-0.0.1-SNAPSHOT.jar' || echo "Nenhuma aplicaÃ§Ã£o antiga em execuÃ§Ã£o"

            echo "ðŸš€ Iniciando aplicaÃ§Ã£o..."
            nohup bash -c "source .env && java -jar backend-0.0.1-SNAPSHOT.jar" > app.log 2>&1 &

            echo "âœ… AplicaÃ§Ã£o iniciada!"

