name: Deploy Backend to EC2
on:
  push:
    tags:
      - "back-v*"

jobs:
  deploy:
    name: Build and Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Build do backend
        run: |
          cd backend
          chmod +x mvnw
          ./mvnw clean package -DskipTests

      - name: Copia o JAR para EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "backend/target/backend-0.0.1-SNAPSHOT.jar"
          target: "~/spring-angular-contatos/backend"

      - name: Sobe a aplica√ß√£o no EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/spring-angular-contatos/backend

            echo "üõë Encerrando aplica√ß√£o antiga se existir..."
            pkill -f 'backend-0.0.1-SNAPSHOT.jar' || true

            echo "üöÄ Iniciando aplica√ß√£o com vari√°veis seguras..."
            nohup java -jar backend-0.0.1-SNAPSHOT.jar \
              --spring.profiles.active=prod \
              --spring.datasource.url="${{ secrets.DB_URL }}" \
              --spring.datasource.username="${{ secrets.DB_USERNAME }}" \
              --spring.datasource.password="${{ secrets.DB_PASSWORD }}" \
              --spring.security.oauth2.resourceserver.jwt.issuer-uri="${{ secrets.COGNITO_ISSUER_URI }}" \
              --cognito.region="${{ secrets.COGNITO_REGION }}" \
              --cognito.userPoolId="${{ secrets.COGNITO_USER_POOL_ID }}" \
              --cognito.clientId="${{ secrets.COGNITO_CLIENT_ID }}" \
              > ~/app.log 2>&1 &

            echo "üîç Verificando sa√∫de da aplica√ß√£o..."
            sleep 10
            curl -f http://localhost:8080/actuator/health || {
              echo "‚ùå A aplica√ß√£o n√£o respondeu na porta 8080!";
              exit 1;
            }
