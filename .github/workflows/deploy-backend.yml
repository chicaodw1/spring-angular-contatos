name: Deploy Backend to EC2

on:
  push:
    tags:
      - "back-v*"

jobs:
  deploy:
    name: Build and Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Build do backend
        run: |
          cd backend
          chmod +x mvnw
          ./mvnw clean package -DskipTests

      - name: Copia o JAR para EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "backend/target/backend-0.0.1-SNAPSHOT.jar"
          target: "~/spring-angular-contatos/backend/target"

      - name: Sobe a aplica√ß√£o no EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ~/spring-angular-contatos/backend

            echo "üîí Gravando vari√°veis no .env permanente..."
            cat > .env <<EOF
            export DB_URL=${{ secrets.DB_URL }}
            export DB_USERNAME=${{ secrets.DB_USERNAME }}
            export DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            export COGNITO_ISSUER_URI=${{ secrets.COGNITO_ISSUER_URI }}
            export COGNITO_REGION=${{ secrets.COGNITO_REGION }}
            export COGNITO_USER_POOL_ID=${{ secrets.COGNITO_USER_POOL_ID }}
            export COGNITO_CLIENT_ID=${{ secrets.COGNITO_CLIENT_ID }}
            EOF

            echo "‚úÖ Adicionando ao .bash_profile para manter ap√≥s reboot..."
            grep -qxF "source ~/spring-angular-contatos/backend/.env" ~/.bash_profile || echo "source ~/spring-angular-contatos/backend/.env" >> ~/.bash_profile
            source ~/.bash_profile

            echo "üõë Parando aplica√ß√£o antiga se estiver rodando..."
            pkill -f 'backend-0.0.1-SNAPSHOT.jar' || true

            echo "üöÄ Iniciando aplica√ß√£o com nohup..."
            nohup java -jar target/backend-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod > ~/app.log 2>&1 &

            echo "‚åõ Aguardando aplica√ß√£o iniciar..."
            sleep 10

            echo "üîç Checando sa√∫de da aplica√ß√£o..."
            curl -f http://localhost:8080/actuator/health || {
              echo "‚ùå A aplica√ß√£o n√£o respondeu na porta 8080!";
              exit 1;
            }

            echo "‚úÖ Aplica√ß√£o em execu√ß√£o com sucesso!"
