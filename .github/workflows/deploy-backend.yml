name: Deploy Backend to EC2

on:
  push:
    tags:
      - "back-v*"

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Limpa target local
        run: rm -rf backend/target

      - name: Limpa projeto antigo no EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "🧹 Limpando projeto antigo no EC2..."
            rm -rf spring-angular-contatos/backend/*

      - name: Copia arquivos para EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "backend"
          target: "~/spring-angular-contatos"

      - name: SSH e build
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd spring-angular-contatos/backend

            echo "🧹 Limpando arquivos antigos..."
            rm -rf target/

            chmod +x mvnw

            echo "💡 Exportando variáveis de ambiente..."
            export DB_URL="${{ secrets.DB_URL }}"
            export DB_USERNAME="${{ secrets.DB_USERNAME }}"
            export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
            export COGNITO_ISSUER_URI="${{ secrets.COGNITO_ISSUER_URI }}"
            export COGNITO_REGION="${{ secrets.COGNITO_REGION }}"
            export COGNITO_USER_POOL_ID="${{ secrets.COGNITO_USER_POOL_ID }}"
            export COGNITO_CLIENT_ID="${{ secrets.COGNITO_CLIENT_ID }}"

            echo "🛠️ Buildando projeto..."
            ./mvnw clean install

            echo "🔍 Procurando JAR..."
            JAR_NAME=$(ls target/*.jar | head -n 1)

            echo "🛑 Matando app antigo..."
            pkill -f 'java' || true

            echo "🚀 Subindo app..."
            nohup java -jar $JAR_NAME > app.log 2>&1 &

            echo "✅ Aplicação iniciada com sucesso!"
            exit 0
